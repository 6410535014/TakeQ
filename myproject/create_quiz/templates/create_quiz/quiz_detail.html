{% extends "base.html" %}

{% block title %}
  <title>รายละเอียด Quiz - {{ quiz.title }}</title>
{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center">
    <h2>{{ quiz.title }}</h2>
    <div>
      <a class="btn btn-sm btn-primary" href="{% url 'create_quiz:add_question' quiz.pk %}">เพิ่มคำถาม</a>
      <a class="btn btn-sm btn-secondary" href="{% url 'create_quiz:quiz_attempts' quiz.pk %}">ดูการเข้าทำ Quiz</a>
      <form method="post" action="{% url 'create_quiz:quiz_delete' quiz.pk %}" style="display:inline;">
        {% csrf_token %}
        <input type="hidden" name="room" value="{{ room_code }}">
        <button type="submit"
                class="btn btn-sm btn-danger"
                onclick="return confirm('Delete this quiz? This action cannot be undone.');">
          ลบ Quiz
        </button>
      </form>
      <a class="btn btn-sm btn-dark" href="{% url 'room:detail' room_code %}">ย้อนกลับ</a>
    </div>
  </div>

  {% if quiz.time_limit_minutes %}
    <div class="mt-2">
      <span class="badge bg-info text-dark">
        กำหนดเวลา: {{ quiz.time_limit_minutes }} นาที{% if quiz.time_limit_minutes != 1 %}s{% endif %}
      </span>
    </div>
  {% endif %}

  <p class="text-muted">{{ quiz.description }}</p>

  <hr>

  <h4>คำถาม</h4>

  <div id="questions-list" class="list-group">
    {% for q in quiz.questions.all|dictsort:"order" %}
      <div class="list-group-item d-flex justify-content-between align-items-center" draggable="true" data-qid="{{ q.id }}">
        <div>
          <span class="drag-handle me-2" style="cursor:grab">☰</span>
          <strong>{{ q.order }}.</strong> {{ q.text }}
        </div>
        <div class="d-flex gap-1">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'create_quiz:edit_question' q.pk %}">แก้ไข</a>

          <form method="post" action="{% url 'create_quiz:delete_question' q.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Delete this question? This action cannot be undone.');">
              ลบ
            </button>
          </form>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">ยังไม่มีคำถาม</p>
    {% endfor %}
  </div>

  <div class="mt-3 d-flex align-items-center">
    <button id="save-order-btn" class="btn btn-primary">บันทึกลำดับ</button>
    <span id="save-status" class="ms-3"></span>
  </div>
</div>

<script>

(function(){
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  const list = document.getElementById('questions-list');
  const saveBtn = document.getElementById('save-order-btn');
  const statusEl = document.getElementById('save-status');

  if(!list) {
    console.warn('questions list element not found.');
    return;
  }

  let dragEl = null;

  function onDragStart(e){
    dragEl = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', dragEl.dataset.qid);
    dragEl.style.opacity = '0.5';
  }
  function onDragEnd(e){
    if(dragEl) dragEl.style.opacity = '';
    dragEl = null;
  }
  function onDragOver(e){
    e.preventDefault();
    const target = e.target.closest('.list-group-item');
    if(!target || target === dragEl) return;
    const rect = target.getBoundingClientRect();
    const after = (e.clientY - rect.top) > (rect.height / 2);
    if(after){
      target.parentNode.insertBefore(dragEl, target.nextSibling);
    } else {
      target.parentNode.insertBefore(dragEl, target);
    }
  }

  function attachDragEvents() {
    const items = list.querySelectorAll('.list-group-item');
    items.forEach(item=>{
      item.setAttribute('draggable', 'true');
      item.addEventListener('dragstart', onDragStart);
      item.addEventListener('dragend', onDragEnd);
      item.addEventListener('dragover', onDragOver);
    });
  }
  attachDragEvents();

  function collectOrder(){
    const items = Array.from(list.querySelectorAll('.list-group-item'));
    return items.map(it => parseInt(it.dataset.qid, 10));
  }

  saveBtn.addEventListener('click', function(){
    statusEl.innerText = 'Saving...';
    const order = collectOrder();
    const url = "{% url 'create_quiz:reorder_questions' quiz.pk %}";

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({order: order})
    }).then(async res => {
      if(res.ok){
        statusEl.innerText = 'กำลังบันทึก...';
        setTimeout(()=> window.location.href = "{% url 'room:detail' room_code %}", 400);
        return;
      }
      let txt = await res.text();
      console.error('Reorder failed', res.status, txt);
      try {
        const j = JSON.parse(txt);
        statusEl.innerText = 'Error: ' + (j.error || res.status);
      } catch(e){
        statusEl.innerText = 'Error saving (status ' + res.status + ')';
      }
    }).catch(err=>{
      console.error('Fetch error', err);
      statusEl.innerText = 'Network error';
    });
  });
})();
</script>
{% endblock %}
